/* Copyright 2017-2021 Sean Williams
    This file is part of Modern Footnotes.

    This program is free software; you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation; either version 2 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License along
    with this program; if not, write to the Free Software Foundation, Inc.,
    51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
*/
function modern_footnotes_hide_footnotes(o){if(window.modernFootnotesOpenedFootnoteViaHover=!1,null!=o){o.data("unopenedContent")&&o.html(o.data("unopenedContent"));let t='.modern-footnotes-footnote__note[data-mfn="'+o.parent().attr("data-mfn")+'"]',e=o.parent().nextAll(t).eq(0);e.hide().css({left:"",top:""}),e.next(".modern-footnotes-footnote__connector").remove(),o.removeClass("modern-footnotes-footnote--selected"),o.attr("aria-pressed","false"),o.focus()}else jQuery(".modern-footnotes-footnote a").each(function(){var o=jQuery(this);o.data("unopenedContent")&&o.html(o.data("unopenedContent"))}),jQuery(".modern-footnotes-footnote > a").attr("aria-pressed","false"),jQuery(".modern-footnotes-footnote__note").hide().css({left:"",top:""}),jQuery(".modern-footnotes-footnote__connector").remove(),jQuery(".modern-footnotes-footnote--selected").removeClass("modern-footnotes-footnote--selected")}function modern_footnotes_show_tooltip_footnote(o,t,e){modern_footnotes_hide_footnotes(),o.toggleClass("modern-footnotes-footnote--selected");let n='.modern-footnotes-footnote__note[data-mfn="'+o.attr("data-mfn")+'"]';var s=o.nextAll(n).eq(0);s.show().addClass("modern-footnotes-footnote__note--tooltip").removeClass("modern-footnotes-footnote__note--expandable"),e&&s.addClass(e),t||s.focus(),s.unbind("keydown").bind("keydown",function(t){"Escape"==t.key&&modern_footnotes_hide_footnotes(o.children("a"))});var r=o.position(),d=Math.floor(1.5*parseInt(o.parent().css("font-size").replace(/px/,""))),f=s.outerWidth(),i=(jQuery(window).width(),r.left-f/2);i<0&&(i=8),i+f>jQuery(window).width()&&(i=jQuery(window).width()-f);var a=parseInt(r.top)+parseInt(d);s.css({top:a+"px",left:i+"px"}),s.after('<div class="modern-footnotes-footnote__connector"></div>');var m=o.position(),l=o.outerHeight(),_=o.outerWidth(),h=a-m.top-l;jQuery(".modern-footnotes-footnote__connector").css({top:m.top+l+"px",height:h,left:m.left+_/2+"px"})}jQuery(function(o){o(document).on("mouseenter",".modern-footnotes-footnote.modern-footnotes-footnote--hover-on-desktop a",null,function(t){o(window).width()>=768&&(window.modernFootnotesActivelyHovering=!0,window.modernFootnotesOpenedFootnoteViaHover=!0,modern_footnotes_show_tooltip_footnote(o(this).parent(),!0,"modern-footnotes-footnote__note--opened-by-hover"))}),o(document).on("mouseenter",".modern-footnotes-footnote__connector,.modern-footnotes-footnote__note",null,function(o){window.modernFootnotesActivelyHovering=!0}),o(document).on("mouseleave",".modern-footnotes-footnote.modern-footnotes-footnote--hover-on-desktop,.modern-footnotes-footnote.modern-footnotes-footnote--hover-on-desktop .modern-footnotes-footnote__connector,.modern-footnotes-footnote__note--opened-by-hover",null,function(t){null!=window.modernFootnotesHoverCloseTimeout&&clearTimeout(window.modernFootnotesHoverCloseTimeout),window.modernFootnotesActivelyHovering&&(window.modernFootnotesHoverCloseTimeout=setTimeout(function(){window.modernFootnotesHoverCloseTimeout=null,window.modernFootnotesActivelyHovering||(modern_footnotes_hide_footnotes(),o(".modern-footnotes-footnote__note--opened-by-hover").removeClass("modern-footnotes-footnote__note--opened-by-hover"))},600)),window.modernFootnotesActivelyHovering=!1}),o(document).on("click",".modern-footnotes-footnote a",null,function(t){t.preventDefault(),t.stopPropagation(),next='.modern-footnotes-footnote__note[data-mfn="'+o(this).parent().attr("data-mfn")+'"]';var e=o(this).parent().nextAll(next).eq(0);e.is(":hidden")?o(window).width()>=768&&o(this).parent().is(":not(.modern-footnotes-footnote--expands-on-desktop)")?(modern_footnotes_show_tooltip_footnote(o(this).parent()),o(this).attr("aria-pressed","true")):(o(window).width()<768||o(this).parent().is(":not(.modern-footnotes-footnote--hover-on-desktop)"))&&(o(this).attr("aria-pressed","true"),e.removeClass("modern-footnotes-footnote__note--tooltip").addClass("modern-footnotes-footnote__note--expandable").css("display","block"),o(this).data("unopenedContent",o(this).html()),o(this).html("x")):modern_footnotes_hide_footnotes(o(this))}).on("click",".modern-footnotes-footnote__note",null,function(o){o.stopPropagation()}).on("click",function(){o(window).width()>=768&&0==o(".modern-footnotes-footnote--expands-on-desktop").length&&modern_footnotes_hide_footnotes()}),o(window).resize(function(){modern_footnotes_hide_footnotes()});var t=o("body .modern-footnotes-footnote a"),e={};t.length>1&&t.each(function(){var t=o(this).parent().attr("data-mfn-post-scope");if(void 0===e[t]&&(e[t]=[0]),o(this).is("a[data-mfn-reset]")&&(e[t]=[0]),o(this).is("a[refnum]")){var n=o(this).attr("refnum");o(this).html()!=n&&o(this).html(n),!isNaN(parseFloat(n))&&isFinite(n)&&e[t].push(n)}else{var s=Math.max.apply(null,e[t])+1;o(this).html()!=s&&o(this).html(s),e[t].push(s)}})});